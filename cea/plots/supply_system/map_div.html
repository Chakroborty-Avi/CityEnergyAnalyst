<div id="{{ id }}" style="height: 500px; position: relative;" oncontextmenu="return false;">
  <div id="map-tooltip-{{ id }}"></div>
  <div id="layers-group-{{ id }}">
    <span class="layer-toggle-{{ id }}">
      <label>
        <input id='connected-{{ id }}' type='checkbox' name='layer-toggle-{{ id }}' value='connected' checked
        onchange="redraw()">
        Connected Buildings
      </label>
    </span>
    <span class="layer-toggle-{{ id }}">
      <label>
        <input id='disconnected-{{ id }}' type='checkbox' name='layer-toggle-{{ id }}' value='disconnected' checked
        onchange="redraw()">
        Disconnected Buildings
      </label>
    </span>
    <span class="layer-toggle-{{ id }}">
      <label>
        <input id='network-{{ id }}' type='checkbox' name='layer-toggle-{{ id }}' value='network' checked
        onchange="redraw()">
        Network
      </label>
    </span>
  </div>
  <div style="position: absolute; z-index: 5; background: #fff; padding: 5px;">
    <h4>Network Type: </h4>
    <label id="dc-{{ id }}-label" style="display: block">
      <input type="radio" id="dc-{{ id }}" name="network-type-{{ id }}" value="dc" onclick="redraw()">
      District Cooling
    </label>
    <label id="dh-{{ id }}-label" style="display: block">
      <input type="radio" id="dh-{{ id }}" name="network-type-{{ id }}" value="dh" onclick="redraw()">
      District Heating
    </label>
  </div>
</div>

<style>
  #map-tooltip-{{ id }}:empty {display: none;}
  #map-tooltip-{{ id }} {
    font-family: Helvetica, Arial, sans-serif;
    position: absolute;
    padding: 4px;
    margin: 8px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    max-width: 300px;
    font-size: 10px;
    z-index: 9;
    pointer-events: none;
  }
  #layers-group-{{ id }} {
    display: inline-block;
    text-align: center;
    position: absolute;
    left: 50%;
    top: 15px;
    transform: translateX(-50%);
    z-index: 1;
    background: rgba(255,255,255,0.9);
  }
  .layer-toggle-{{ id }} {
    padding: 0 10px;
  }
</style>

<script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<script>
    const data = {{ data }};
    const zone = {{ zone }};
    const dc = checkEmpty({{ dc }}, 'dc');
    const dh = checkEmpty({{ dh }}, 'dh');

    const connectedToggle = document.getElementById('connected-{{ id }}');
    const disconnectedToggle = document.getElementById('disconnected-{{ id }}');
    const networkToggle = document.getElementById('network-{{ id }}');

    const lightMap = {
        "version": 8,
        "sources": {
            "osm-tiles": {
                "type": "raster",
                "tiles": [
                    "http://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    "http://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    "http://b.tile.openstreetmap.org/{z}/{x}/{y}.png"
                ],
                "tileSize": 256,
                "attribution": "Map data \u00A9 OpenStreetMap contributors"
            }
        },
        "layers": [{
            "id": "osm-tiles",
            "type": "raster",
            "source": "osm-tiles",
            "minzoom": 0,
            "maxzoom": 22
        }]
    };

    let currentViewState = {
        latitude: 0,
        longitude: 0,
        zoom: 0, bearing: 0, pitch: 0
    };

    let cameraOptions = {};

    let filtered = {dc:{}, dh:{}};

    const deckgl = new DeckGL({
        container: '{{ id }}',
        mapStyle: lightMap,
        viewState: currentViewState,
        layers: [],
        onViewStateChange: ({viewState}) => {
            currentViewState = viewState;
            deckgl.setProps({viewState: currentViewState});
        }
    });

    centerCamera();
    checkFirstRadio();
    redraw();

    function redraw() {
        // Add zone layer
        let layers = [new GeoJsonLayer({
            id: 'zone',
            data: filterBuildings(zone),
            opacity: 0.5,
            wireframe: true,
            filled: true,

            getElevation: f => f.properties['height_ag'],
            getFillColor: f => buildingColor(f),

            pickable: true,
            autoHighlight: true,
            highlightColor: [255, 255, 0, 128],

            onHover: updateTooltip
        })];

        // Add DC network layer
        if (dc) layers.push(new GeoJsonLayer({
            id:'dc',
            data: dc,
            stroked: false,
            filled: true,
            visible: getNetworkVisibility('dc'),

            getLineColor: [0, 255, 255],
            getFillColor: f => nodeFillColor(f.properties['Type']),
            getLineWidth: 3,
            getRadius: 3,

            pickable: true,
            autoHighlight: true,

            onHover: updateTooltip
        }));

        // Add DH network layer
        if (dh) layers.push(new GeoJsonLayer({
            id:'dh',
            data: dh,
            stroked: false,
            filled: true,
            visible: getNetworkVisibility('dh'),

            getLineColor: [0, 255, 0],
            getFillColor: f => nodeFillColor(f.properties['Type']),
            getLineWidth: 3,
            getRadius: 3,

            pickable: true,
            autoHighlight: true,

            onHover: updateTooltip
        }));

        deckgl.setProps({layers})
    }

    function buildingColor(object) {
        let connected = data.connected_buildings_DH;
        if (connected.includes(object.properties.Name)) return [0, 255, 0];
        return [0, 0, 255]
    }

    function nodeFillColor(type) {
        if (type === 'NONE') {
            return [100, 100, 100]
        } else if (type === 'CONSUMER') {
            return [255, 255, 255]
        } else if (type === 'PLANT') {
            return [0, 0, 0]
        }
    }

    function centerCamera() {
        if (zone) {
            let bbox = zone.bbox;
            cameraOptions = deckgl.getMapboxMap().cameraForBounds(
                [[bbox[0], bbox[1]], [bbox[2], bbox[3]]],
                {padding: 30, maxZoom: 18}
            );

            deckgl.setProps({
                viewState: {
                    ...currentViewState,
                    zoom: cameraOptions.zoom,
                    latitude: cameraOptions.center.lat,
                    longitude: cameraOptions.center.lng
                }
            });
        }
    }

    function filterBuildings(out) {
        let type = document.querySelector('input[name="network-type-{{ id }}"]:checked').value;
        let features;
        if (connectedToggle.checked && !disconnectedToggle.checked) {
            if (typeof(filtered[type].connected) === 'undefined') {
                features = out.features.filter(feature => {
                    return data[`connected_buildings_${type.toUpperCase()}`].includes(feature.properties.Name)
                });
                filtered[type].connected = features;
            }
            return filtered[type].connected;
        }
        if (!connectedToggle.checked && disconnectedToggle.checked) {
            if (typeof(filtered[type].disconnected) === 'undefined') {
                features = out.features.filter(feature => {
                    return data[`disconnected_buildings_${type.toUpperCase()}`].includes(feature.properties.Name)
                });
                filtered[type].disconnected = features;
            }
            return filtered[type].disconnected;
        }
        if (!connectedToggle.checked && !disconnectedToggle.checked) return [];
        return out;
    }

    function updateTooltip({x, y, object, layer}) {
        const tooltip = document.getElementById('map-tooltip-{{ id }}');
        if (object) {
            tooltip.style.top = `${y}px`;
            tooltip.style.left = `${x}px`;
            let innerHTML = '';

            if (layer.id === 'zone' || layer.id === 'district') {
                $.each(object.properties, function (key, value)  {
                    innerHTML += `<div><b>${key}</b>: ${value}</div>`;
                });
                let area = turf.area(object);
                innerHTML += `<br><div><b>area</b>: ${Math.round(area * 1000) / 1000}m<sup>2</sup></div>` +
                    `<div><b>volume</b>: ${Math.round(area * object.properties['height_ag'] * 1000) / 1000}m<sup>3</sup></div>`;
            } else if (layer.id === 'dc_networks' || layer.id === 'dh_networks') {
                if (!object.properties.hasOwnProperty("Building")) {
                    let length = turf.length(object) * 1000;
                    innerHTML += `<br><div><b>length</b>: ${Math.round(length * 1000) / 1000}m</div>`;
                }
            } else {
                $.each(object.properties, function (key, value) {
                    innerHTML += `<div><b>${key}</b>: ${value}</div>`;
                });
            }

            tooltip.innerHTML = innerHTML;
        } else {
            tooltip.innerHTML = '';
        }
    }

    function checkEmpty(json, type) {
        let empty = !Object.keys(json).length;
        if (empty) {
            document.getElementById(`${type}-{{ id }}-label`).remove();
        }
        return empty ? null : json
    }

    function checkFirstRadio() {
        document.getElementsByName("network-type-{{ id }}")[0].checked = true;
    }

    function getNetworkVisibility(type) {
        return document.getElementById(`${type}-{{ id }}`).checked
            && networkToggle.checked
    }
</script>